<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OrÃ§amento Profissional - GÃªnesis Azulejista</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body{font-family:Arial,sans-serif;background:#f3f4f6;margin:0;padding:0;}
  .container{max-width:800px;margin:auto;padding:20px;}
  h1{text-align:center;color:#111827;}
  .card, .nota, .historico{background:#fff;padding:20px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,0.1);margin-bottom:20px;}
  label{display:block;margin-top:10px;font-weight:bold;}
  input,select,textarea{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:8px;}
  button{background:#ffcc00;color:#111;border:none;padding:10px 12px;border-radius:8px;margin-top:15px;cursor:pointer;font-weight:bold;}
  button:hover{background:#e6b800;}
  .limpar{background:#dc3545;color:#fff;}
  .limpar:hover{background:#a71d2a;}
  .whatsapp{background:#25d366;color:#fff;}
  .whatsapp:hover{background:#1da851;}
  .qr-area{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap;}
  #qrcode{background:#fff;padding:8px;border-radius:10px;}
  .btn-group button { margin-right: 10px; }
  .menu{display:flex;gap:10px;margin-bottom:20px;}
  .menu button{flex:1;}
  .total-box{background:#ffecb3;padding:10px;border-radius:10px;margin-top:10px;text-align:center;font-size:18px;font-weight:bold;}
</style>
</head>
<body>
<div class="container">

  <h1>ğŸ“‹ PrestaÃ§Ã£o Servico - Marco Azulejista</h1>

  <div class="menu">
    <button onclick="mostrarSecao('preencher')">ğŸ“ Preencher</button>
    <button onclick="mostrarSecao('nota')">ğŸ§¾ Nota Gerada</button>
    <button onclick="mostrarSecao('historico')">ğŸ“‚ HistÃ³rico</button>
  </div>

  <!-- Preenchimento -->
  <div id="preencher" class="card">
    <label>Nome do Cliente</label><input type="text" id="nome">
    <label>CPF do Cliente</label><input type="text" id="cpfCliente" maxlength="14" placeholder="000.000.000-00">
    <label>EndereÃ§o (Rua)</label><input type="text" id="endereco">
    <label>NÃºmero</label><input type="text" id="numero">
    <label>Bairro</label><input type="text" id="bairro">
    <label>Cidade</label><input type="text" id="cidade">
    <label>Data</label><input type="date" id="data">
    <label>DescriÃ§Ã£o do ServiÃ§o</label><textarea id="descricao" rows="4" placeholder="Um item por linha"></textarea>
    <label>Valor Total (R$)</label><input type="number" id="valor" step="0.01" oninput="atualizarRestante()">
    <label>Valor Recebido / Sinal (R$)</label><input type="number" id="sinal" step="0.01" oninput="atualizarRestante()">
    <label>Restante (R$)</label><input type="number" id="restanteValor" readonly>
    <label>Forma de Pagamento</label>
    <select id="forma">
      <option value="PIX">PIX</option>
      <option value="Dinheiro">Dinheiro</option>
      <option value="CartÃ£o de CrÃ©dito">CartÃ£o de CrÃ©dito</option>
    </select>

    <!-- Prestador -->
    <label>Nome do Prestador</label><input type="text" id="prestador" value="GÃªnesis Azulejista">
    <label>CPF do Prestador</label><input type="text" id="cpf" value="123.456.789-00">
    <label>EndereÃ§o do Prestador</label><input type="text" id="enderecoPrestador" value="Rua Exemplo, 100 - Bairro, Cidade">
    <label>Chave PIX</label><input type="text" id="chavePix" value="04461680681">

    <div class="qr-area">
      <div id="qrcode"></div>
      <button onclick="gerarQR()">Gerar QR PIX</button>
      <button onclick="copiarChave()">ğŸ“‹ Copiar Chave PIX</button>
      <span id="copyMsg" style="display:none;color:green;font-weight:bold;">âœ… Copiada!</span>
    </div>

    <div class="btn-group">
      <button onclick="preencherRapido()">âš¡ Preencher rÃ¡pido</button>
      <button onclick="gerarNota()">ğŸ’¾ Gerar Nota</button>
      <button class="whatsapp" onclick="enviarWhatsApp()">ğŸ“² Enviar WhatsApp</button>
      <button class="limpar" onclick="limparCampos()">ğŸ”„ Limpar</button>
    </div>
  </div>

  <!-- Nota Gerada -->
  <div id="nota" class="nota" style="display:none;"></div>

  <!-- HistÃ³rico -->
  <div id="historico" class="historico" style="display:none;">
    <h3>ğŸ“Š HistÃ³rico de Notas</h3>
    <div id="listaHistorico"></div>
    <div class="total-box">
      ğŸ’° Total do MÃªs: R$ <span id="totalMes">0,00</span>
    </div>
    <button class="limpar" onclick="limparHistorico()">ğŸ—‘ï¸ Limpar HistÃ³rico</button>
  </div>

</div>

<script>
let registros = JSON.parse(localStorage.getItem("orcamentos3")) || [];

function mostrarSecao(secao){
  document.getElementById('preencher').style.display = secao==='preencher'?'block':'none';
  document.getElementById('nota').style.display = secao==='nota'?'block':'none';
  document.getElementById('historico').style.display = secao==='historico'?'block':'none';
}

function atualizarRestante(){
  const valor=parseFloat(document.getElementById('valor').value)||0;
  const sinal=parseFloat(document.getElementById('sinal').value)||0;
  const restante=valor-sinal;
  document.getElementById('restanteValor').value=restante>0?restante.toFixed(2):"0.00";
}

function gerarQR(){
  const chave=document.getElementById('chavePix').value;
  const sinal=parseFloat(document.getElementById('sinal').value)||0;
  if(!chave){alert("Informe a chave PIX!"); return;}
  const texto=`Pagamento para ${chave}\nValor: R$ ${sinal.toFixed(2)}`;
  document.getElementById('qrcode').innerHTML="";
  QRCode.toCanvas(texto,{width:150},function(err,canvas){
    if(err){alert("Erro ao gerar QR."); return;}
    document.getElementById('qrcode').appendChild(canvas);
  });
}

function copiarChave(){
  const chave=document.getElementById('chavePix').value;
  if(!chave){alert("Nenhuma chave PIX informada."); return;}
  navigator.clipboard.writeText(chave).then(()=>{
    const msg=document.getElementById("copyMsg");
    msg.style.display="inline";
    setTimeout(()=>msg.style.display="none",2000);
  });
}

function gerarNota(){
  const nome=document.getElementById('nome').value.trim();
  const cpfCliente=document.getElementById('cpfCliente').value.trim();
  const endereco=document.getElementById('endereco').value.trim();
  const numero=document.getElementById('numero').value.trim();
  const bairro=document.getElementById('bairro').value.trim();
  const cidade=document.getElementById('cidade').value.trim();
  const data=document.getElementById('data').value;
  const descricao=document.getElementById('descricao').value.trim();
  const valor=parseFloat(document.getElementById('valor').value)||0;
  const sinal=parseFloat(document.getElementById('sinal').value)||0;
  const restante=valor-sinal;
  const forma=document.getElementById('forma').value;

  const prestador=document.getElementById('prestador').value;
  const cpfPrestador=document.getElementById('cpf').value;
  const enderecoPrestador=document.getElementById('enderecoPrestador').value;
  const chavePix=document.getElementById('chavePix').value;

  if(!nome||!cpfCliente||!endereco||!numero||!bairro||!cidade||!valor){
    alert("Preencha todos os campos obrigatÃ³rios!");
    return;
  }

  const enderecoCompleto=`${endereco}, ${numero} - ${bairro}, ${cidade}`;
  const descricaoFormatada = descricao.split("\n").map(item=>`<p>${item}</p>`).join('');

  const notaHTML=`
    <h2>ğŸ“„ Nota de OrÃ§amento</h2>
    <p><strong>Data:</strong> ${data?new Date(data).toLocaleDateString('pt-BR'):"-"}</p>
    <p><strong>Cliente:</strong> ${nome}</p>
    <p><strong>CPF:</strong> ${cpfCliente}</p>
    <p><strong>EndereÃ§o:</strong> ${enderecoCompleto}</p>
    <p><strong>ServiÃ§o:</strong></p>
    ${descricaoFormatada}
    <p><strong>Valor Total:</strong> R$ ${valor.toFixed(2)}</p>
    <p><strong>Valor Recebido:</strong> R$ ${sinal.toFixed(2)} (${forma})</p>
    <p><strong>Restante:</strong> R$ ${restante>0?restante.toFixed(2):"0.00"}</p>
    <p><strong>Prestador:</strong> ${prestador} - CPF: ${cpfPrestador}</p>
    <p><strong>EndereÃ§o do Prestador:</strong> ${enderecoPrestador}</p>
    ${forma==="PIX"?`<p><strong>Chave PIX:</strong> ${chavePix}</p>`:""}
    <div id="qrcodeNota"></div>
    <button onclick="gerarQRNota()">Gerar QR PIX</button>
    <button onclick="copiarChave()">ğŸ“‹ Copiar Chave PIX</button>
    <button onclick="imprimirNota()">ğŸ–¨ï¸ Imprimir Nota</button>
  `;
  document.getElementById('nota').innerHTML=notaHTML;
  mostrarSecao('nota');

  const registro={nome,cpfCliente,enderecoCompleto,data,descricao,valor,sinal,restante,forma,prestador,cpfPrestador,enderecoPrestador,chavePix};
  registros.push(registro);
  localStorage.setItem("orcamentos3",JSON.stringify(registros));
  atualizarHistorico();
}

function gerarQRNota(){
  const chave=document.getElementById('chavePix').value;
  const sinal=parseFloat(document.getElementById('sinal').value)||0;
  if(!chave){alert("Informe a chave PIX!"); return;}
  const texto=`Pagamento para ${chave}\nValor: R$ ${sinal.toFixed(2)}`;
  document.getElementById('qrcodeNota').innerHTML="";
  QRCode.toCanvas(texto,{width:150},function(err,canvas){
    if(err){alert("Erro ao gerar QR."); return;}
    document.getElementById('qrcodeNota').appendChild(canvas);
  });
}

async function imprimirNota(){
  const conteudo=document.getElementById('nota').innerHTML;
  const win=window.open('','','width=600,height=700');
  win.document.write(`<html><head><title>Nota</title></head><body>${conteudo}</body></html>`);
  win.document.close();
  win.focus();
  win.print();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  await doc.html(conteudo, {
    callback: function (pdf) {
      pdf.save('nota_orcamento.pdf');
    },
    x: 10,
    y: 10,
    width: 180
  });
}

function enviarWhatsApp(){
  const nome=document.getElementById('nome').value.trim();
  const cpfCliente=document.getElementById('cpfCliente').value.trim();
  const endereco=document.getElementById('endereco').value.trim();
  const numero=document.getElementById('numero').value.trim();
  const bairro=document.getElementById('bairro').value.trim();
  const cidade=document.getElementById('cidade').value.trim();
  const data=document.getElementById('data').value;
  const descricao=document.getElementById('descricao').value.trim();
  const valor=parseFloat(document.getElementById('valor').value)||0;
  const sinal=parseFloat(document.getElementById('sinal').value)||0;
  const restante=valor-sinal;
  const forma=document.getElementById('forma').value;
  const prestador=document.getElementById('prestador').value;
  const cpfPrestador=document.getElementById('cpf').value;
  const enderecoPrestador=document.getElementById('enderecoPrestador').value;
  const chavePix=document.getElementById('chavePix').value;

  if(!nome||!cpfCliente){alert("Gere a nota antes de enviar!"); return;}

  const enderecoCompleto=`${endereco}, ${numero} - ${bairro}, ${cidade}`;
  const msg = `ğŸ“‹ *OrÃ§amento - GÃªnesis Azulejista*\n\n`+
              `ğŸ‘¤ Cliente: ${nome}\n`+
              `ğŸ†” CPF: ${cpfCliente}\n`+
              `ğŸ  EndereÃ§o: ${enderecoCompleto}\n`+
              `ğŸ§± ServiÃ§o: ${descricao}\n`+
              `ğŸ’° Valor Total: R$ ${valor.toFixed(2)}\n`+
              `ğŸ’µ Sinal: R$ ${sinal.toFixed(2)} (${forma})\n`+
              `ğŸ’¸ Restante: R$ ${restante.toFixed(2)}\n`+
              `ğŸ‘· Prestador: ${prestador} - CPF: ${cpfPrestador}\n`+
              `ğŸ  EndereÃ§o Prestador: ${enderecoPrestador}\n`+
              (forma==="PIX"?`ğŸ”‘ Chave PIX: ${chavePix}\n`:"")+
              `\nğŸ“… Obrigado por confiar em nosso trabalho!`;
  const url=`https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url,'_blank');
}

function atualizarHistorico(){
  const lista=document.getElementById('listaHistorico');
  lista.innerHTML="";
  let total=0;
  registros.forEach(r=>{
    total+=r.valor;
    lista.innerHTML+=`<p>ğŸ§± ${r.nome} - ${r.forma} - R$ ${r.valor.toFixed(2)} (${r.data})</p>`;
  });
  document.getElementById('totalMes').innerText=total.toFixed(2).replace('.',',');
}

function limparCampos(){
  if(confirm("Limpar campos?")){
    document.querySelectorAll('input,textarea,select').forEach(e=>{
      if(["estado","prestador","cpf","chavePix","enderecoPrestador"].includes(e.id)) return;
      e.value="";
    });
    document.getElementById('restanteValor').value="";
    document.getElementById('qrcode').innerHTML="";
  }
}

function limparHistorico(){
  if(confirm("Apagar todo o histÃ³rico?")){
    registros=[];
    localStorage.removeItem("orcamentos3");
    atualizarHistorico();
  }
}

function preencherRapido(){
  document.getElementById('nome').value="JoÃ£o Silva";
  document.getElementById('cpfCliente').value="123.456.789-00";
  document.getElementById('endereco').value="Rua das Flores";
  document.getElementById('numero').value="123";
  document.getElementById('bairro').value="Centro";
  document.getElementById('cidade').value="Betim";
  document.getElementById('data').value=new Date().toISOString().split('T')[0];
  document.getElementById('descricao').value="Revestimento de banheiro\nInstalaÃ§Ã£o de porcelanato\nLimpeza final";
  document.getElementById('valor').value="1500.00";
  document.getElementById('sinal').value="500.00";
  atualizarRestante();
  document.getElementById('forma').value="PIX";
}

window.onload=function(){
  atualizarHistorico();
}

// --- Salvar prestador automaticamente ---
(function(){
  const key = 'prestadorDados';
  const elNome = document.getElementById('prestador');
  const elCPF = document.getElementById('cpf');
  const elEndereco = document.getElementById('enderecoPrestador');

  function salvarPrestador() {
    const data = {
      nome: elNome.value,
      cpf: elCPF.value,
      endereco: elEndereco.value
    };
    localStorage.setItem(key, JSON.stringify(data));
  }

  function carregarPrestador() {
    const data = JSON.parse(localStorage.getItem(key)||'{}');
    if(data.nome) elNome.value = data.nome;
    if(data.cpf) elCPF.value = data.cpf;
    if(data.endereco) elEndereco.value = data.endereco;
  }

  [elNome, elCPF, elEndereco].forEach(el=>{
    el.addEventListener('input', salvarPrestador);
  });

  carregarPrestador();
})();
</script>
</body>
</html>
